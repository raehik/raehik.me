---
title: "Creating your own XMB/VSH themes for PSP custom firmware"
date: 2015-12-08 21:40:54
---

The PSP homebrew and hacking scene flourished from the PSP's release up until
2011, when it was phased out and replaced with the PS Vita. Since then, a lot of
the guides and tutorials that used to be available have been lost. Now it's hard
to find detailed guides for homebrew apps and such things, and the few that I
managed to find were often for older or outdated versions. So I worked on a
personal guide for something I wanted to do, and this is the result. It's a long
tutorial and I didn't edit it further, so it's not the easiest read -- consider
yourself warned. Regardless, here's how to create a CTF *from scratch* and
***using a Linux distro*** for usage with CXMB.

The PSP's main menu (called XMB for 'XrossMediaBar') is customisable. Sony
allowed users to create their own themes and share them, but only icons could be
changed. With CFW people have been able to access the PSP's flash memory and
overwrite the resource files to change more things including gameboots, sound
effects and lots more. This page is intended to be a **full guide to all things
PSP theming for Linux systems** (even though most programs required are
Windows...).


Definitions
-----------

  * **PTF:** PSP theme file (I'm assuming that's the abbreviation) generated by
    Sony's Custom Theme Converter. Can change icons and wallpapers, and that's
    pretty much it.
  * **CTF:** Custom theme file (again, assumed). Used by CXMB to override
    resource files stored in the PSP's flash memory (flash0), without you having
    to do it manually.
  * **RCO:** Resource files stored in flash0 which contain various resources
    including
  * **VAG:** Sony's own audio codec, compressed sound format used in the PSX.
    The PSP uses VAG files for its cursor sounds and other XMB sound effects.
    Note that you *can* use both mono and stereo VAG sounds -- just that some
    people suggest against it, perhaps due to space considerations.
  * **XMB:** Sony's XrossMediaBar, the interface used in the PSP, PS3, Sony
    Bravia and maybe a few more Sony products. Can be customised to an extent.
  * **CXMB:** Homebrew VSH plugin which allows changing more XMB elements
    including sounds and icon layouts.
  * **VSH:** The XMB internally? Not really sure. According to [PSP
    handheld][psp-blog], *"The XMB on the PSP is known internally as the
    'VSH'"*.

[psp-blog]: http://psp-handheld.blogspot.co.uk/2011/05/ctf-tool-gui-v44-create-extract-and.html


Overview of the CTF creation process
------------------------------------

To make a CTF (including sounds) *from scratch*, you'd do this:

  * Create a PTF with Custom Theme Converter
      * This is where you choose icons for things.
  * Obtain and decrypt your PSP's RCOs
      * Requires ME CFW for the LEDA plugin to make Resurssiklunssi work
  * Convert sound effects into VAG sound files with MFAudio
  * Replace any sounds in the RCOs that you want to override using RCO Editor
  * [ Do any other CTF things you like (menu placement & other cool things) ]
  * Create a CTF from the PTF and RCOs using CTFtool GUI

Or, a more streamlined list:

  * Change base PTF and export (Custom Theme Converter)
  * Convert some WAVs into VAGs (MFAudio)
  * Make a copy of the RCO you are replacing VAGs in and do it (RCO Editor)
  * Create a CTF from the PTF and any RCOs (CTFtool GUI)

Now I'll cover each of those steps.


### Creating a PTF using Custom Theme Converter

Sony kept their Custom Theme Converter updated 'til the end: the final version
v1.6 works with 6.60 and below. (TODO: what about 6.61?)

Every PTF theme must have the following:

  * Title (string)
  * Product ID (string)
  * Version (integer/float)
  * Preview Icon (16x16, 256 colour, PNG/TGA/GIM) -- PNG doesn't work for me, I
    use TGA
  * Preview Image (300x170, 24 bit colour, BMP)

Title/product ID/version don't change a thing, and you don't even get to see
them on the PSP. Preview icon and image are used when selecting a theme.

For 'Preview Icon', using ImageMagick:

    convert <image> -resize "\!16x16" -colors 256 out.tga

For 'Preview Image', using ImageMagick:

    convert <image> -resize "\!300x170" BMP3:out.bmp

I use BMP3 because imlib2 can't load whatever ImageMagick uses for `.bmp` by
default. Both seem to work with Custom Theme Converter.


### Obtaining your PSP firmware's RCOs

This is for ME/PRO CFW, some strings might be different in respective VSH menus.

Go into the recovery menu (hit Select for the VSH menu), select 'Configuration',
and change 'XMB USB Device' to Flash 0. Then connect to your PC and mount the
disk that shows up (for me it was a plain disk not partitioned):

    $ mkdir tmp
    $ mount -o uid=$(id -u),gid=$(id -g),utf8,ro <device> tmp

*(For some reason I couldn't mount properly to /mnt so I'm giving the
instructions I used myself.)*

The RCOs you want are at `vsh/resource`. Copy the whole folder over to your
computer, then change the USB device back to the memory stick.

Now you need to decompress them using a PSP app, Resurssiklunssi. *However*,
that is a 1.50 kernel app, which recent only old PSPs and CFWs can run (I
think). The workaround is to use LEDA, a 'legacy software loader' which allows
you to run 1.50 kernel homebrew. This only works in ME CFW, so install it if you
haven't, run it, make sure LEDA is enabled in `seplugins/game.txt`, and start
Resurssiklunssi. Hit X, then connect back up and copy across the decompressed
file(s).


### Replacing sounds

To change a sound in a CTF theme, you need to replace the sound's VAG file in
its respective RCO file. A lot of basic system sounds like cursor ticks and
confirmations are kept in `system_plugin.rco`, so we'll use that as an example.


#### Getting a WAV file

First you need a short WAV file with a frequency of **44.1kHz** and **16 bit**
depth. Usually, I'd recommend FFmpeg:

    ffmpeg -i <file> -acodec pcm_s16le -ar 44.1k output.wav

Or less-assuredly, using the fact that those options are default for WAV files:

    ffmpeg -i <file> output.wav

**However**, for some reason this doesn't work. MFAudio complains about it being
an "invalid WAV file". Checking in a hex editor, FFmpeg changes the offset and
generally makes more changes than SoX, another media converter (just audio
unlike FFmpeg's A/V capabilities). SoX works fine, however:

    sox <file> output.wav

So I suggest using SoX to make your WAV files.

Full steps for adding a sound to a CTF theme:

This should be an overview, each step should be gone into in detail in
subsections.


#### Creating & replacing a VAG file

VAG (LMAO) files are a Sony compressed audio format. The PSP uses them in the
VSH for sounds. Converting to VAG isn't something most average audio converters
can handle, so we use **MFAudio** in Wine.

For output file format, you want 'VAG - Sony PSX Sound - Compressed ADPCM'.
Stereo or mono is fine, but remember you have **limited space**, so in most
cases mono will be sufficient. Also, I've only used mono so far -- you might
have to do something different when replacing the VAG if you make it stereo.

To replace a VAG with the new one you've just made, use RCO Editor. It's simple
enough.


### Creating the CTF

Now we have all the resources and files to create a CTF. CTFtool GUI (goes by
CTF Tool GUI, CTFtool GUI) conveniently lets you make CTFs on your computer
rather than using CXMB to package them, so it's definitely worth spending time
to set up. You'll have to use Wine, but CTFtool GUI plays nice with it, even
though being a little poorly designed on the GUI front messes up some window
functions.

The thing is, there are **next to no** guides out there for using CTFtool GUI,
and it requires some certain firmware files to make it produce CTFs for
different firmwares. I eventually found the answer in some thread about another
tool, CTF Manager.

For every firmware that you want to create CTFs for, you need **3 decrypted
PRXs:**

  * common_gui.prx
  * paf.prx
  * vshmain.prx

CTFtool GUI comes with what seems like *all the main firmware files* for a range
of common firmwares (even though only those 3 should be required). You should be
able to create a theme for 6.61 by decrypting the required PRXs from your PSP
and putting them in the folder `base/661`.

**Don't panic** when an error dialog comes up! CTFtool GUI is lying to you!
Every time I make a theme a "CTF Package Error" dialog box pops up and talks
abuot termination and whatnot. Don't worry, the theme should have been properly
created! Full text of the error for extra help (all spelling/grammar exact):

  > CTFtool:CTF Package Error, the task termination
  >
  > Error No.: 6
  > Error Description: Overflow

As long as the CTF has been created, it's probably been successful.

---

And you're done. Copy the CTF over to `ms0:/PSP/THEME` and try it out!


CXMB
----

In earlier PSP homebrew times, to change gameboot sounds and cursor SFX you had
to directly access the PSP's flash memory (named flash0) and overwrite certain
resource files. This is dangerous: [according to ZiNgA BuRgA][bootsounds-guide],
creator of RCO Editor, *"it's possible to semi-brick by flashing RCOs"*.
**CXMB** removes the need to do this by enabling you to create and use CTF
themes, which can override VSH resources in flash0 safely.

[bootsounds-guide]: http://endlessparadigm.com/forum/showthread.php?tid=400


### Installation

To use CXMB, put the `cxmb.prx` file in `ms0:/cxmb` and add a line to
`ms0:/seplugins/vsh.txt`:

    ms0:/cxmb/cxmb.prx 1


### Enabling a CTF theme

Just go into Theme Settings -> Theme and choose one. CTF themes aren't indicated
specially, so you need to know what it might look like (you don't actually get
shown the theme name).


### Disabling the current CTF theme

Changing the theme in Theme Settings to a non-CTF theme (i.e. a PTF) will only
change a few features of the theme. Like, it won't properly revert it. If you
want to remove the current CTF theme, delete the config file CXMB generates at
`ms0:/cxmb/conf.txt`:

    $ mount -o uid=$(id -u),gid=$(id -g),utf8 <device> /mnt
    $ rm /mnt/cxmb/conf.txt
    $ umount /mnt

Then choose the PTF theme you wanted and restart the VSH. Remember that the
wallpaper and colour would have been changed, so you need to reset them if you
choose the default theme or a PTF which doesn't change those.


CTFtool GUI
-----------

To extract resources from **PTFs**, use the top two fields in the 'Extract' tab.
For **CTFs**, use the bottom two fields.
